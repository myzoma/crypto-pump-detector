<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>كاشف البامب - العملات الرقمية</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
    <!-- إضافة favicon لتجنب خطأ 404 -->
    <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64,">
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="header-content">
                <h1><i class="fas fa-chart-line"></i> كاشف البامب للعملات الرقمية</h1>
                <div class="header-actions">
                    <div class="market-status">
                        <span id="marketStatus" class="market-indicator">تحليل السوق...</span>
                    </div>
                    <div class="header-buttons">
                        <button class="header-btn" id="watchlistBtn">
                            <i class="fas fa-bookmark"></i>
                            قائمة المراقبة
                            <span id="watchlist-counter" class="watchlist-counter" style="display: none;">0</span>
                        </button>
                        <button class="header-btn" id="alertsBtn">
                            <i class="fas fa-bell"></i>
                            التنبيهات
                        </button>
                        <button class="header-btn" id="statisticsBtn">
                            <i class="fas fa-chart-bar"></i>
                            الإحصائيات
                        </button>
                        <button class="header-btn" id="exportBtn">
                            <i class="fas fa-download"></i>
                            تصدير البيانات
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <div class="filters-section">
            <div class="filter-buttons">
                <button class="filter-btn active" data-score="all">جميع العملات</button>
                <button class="filter-btn" data-score="100">100 نقطة</button>
                <button class="filter-btn" data-score="90">90+ نقطة</button>
                <button class="filter-btn" data-score="80">80+ نقطة</button>
                <button class="filter-btn" data-score="70">70+ نقطة</button>
                <button class="filter-btn" data-score="60">60+ نقطة</button>
            </div>
                        
            <div class="controls-section">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="البحث عن عملة..." />
                    <i class="fas fa-search"></i>
                </div>
                                
                <div class="sort-controls">
                    <select id="sortSelect">
                        <option value="score">ترتيب حسب النقاط</option>
                        <option value="change">ترتيب حسب التغيير</option>
                        <option value="volume">ترتيب حسب الحجم</option>
                        <option value="price">ترتيب حسب السعر</option>
                    </select>
                </div>
                                
                <div class="refresh-section">
                    <button id="refreshBtn" class="refresh-btn">
                        <i class="fas fa-sync-alt"></i> تحديث البيانات
                    </button>
                    <span id="lastUpdate" class="last-update">آخر تحديث: --</span>
                </div>
            </div>
        </div>

        <!-- شريط المعلومات السريعة -->
        <div class="quick-info-bar">
            <div class="info-item">
                <span class="info-label">إجمالي العملات:</span>
                <span id="totalCoins" class="info-value">0</span>
            </div>
            <div class="info-item">
                <span class="info-label">عملات صاعدة:</span>
                <span id="bullishCoins" class="info-value positive">0</span>
            </div>
            <div class="info-item">
                <span class="info-label">عملات هابطة:</span>
                <span id="bearishCoins" class="info-value negative">0</span>
            </div>
            <div class="info-item">
                <span class="info-label">متوسط النقاط:</span>
                <span id="averageScore" class="info-value">0</span>
            </div>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>جاري تحليل العملات...</p>
        </div>

        <div class="coins-grid" id="coinsGrid">
            <!-- البطاقات ستظهر هنا -->
        </div>

        <!-- رسالة عدم وجود نتائج -->
        <div class="no-results" id="noResults" style="display: none;">
            <i class="fas fa-search"></i>
            <h3>لا توجد نتائج</h3>
            <p>لم يتم العثور على عملات تطابق معايير البحث</p>
        </div>
    </div>

    <!-- النافذة المنبثقة للتفاصيل -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <div class="modal-header">
                <h2 id="modalTitle"></h2>
                <button class="close-btn" id="closeModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content" id="modalContent">
                <!-- محتوى التحليل التفصيلي -->
            </div>
        </div>
    </div>

    <!-- منطقة الإشعارات -->
    <div id="notificationsContainer" class="notifications-container"></div>

    <!-- شريط التحكم السفلي -->
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-info">
                <span>تم تحليل <span id="analyzedCount">0</span> عملة</span>
                <span>آخر تحديث: <span id="footerLastUpdate">--</span></span>
            </div>
            <div class="footer-actions">
                <button class="footer-btn" id="scrollTopBtn">
                    <i class="fas fa-arrow-up"></i>
                    العودة للأعلى
                </button>
                <button class="footer-btn" id="autoRefreshBtn">
                    <i class="fas fa-clock"></i>
                    <span id="autoRefreshText">تفعيل التحديث التلقائي</span>
                </button>
            </div>
        </div>
    </footer>

    <!-- أزرار عائمة -->
    <div class="floating-buttons">
        <button class="floating-btn primary" id="floatingWatchlistBtn" title="قائمة المراقبة">
            <i class="fas fa-bookmark"></i>
            <span id="floating-watchlist-counter" class="floating-counter watchlist-counter">0</span>
        </button>
        <button class="floating-btn secondary" id="floatingAlertsBtn" title="التنبيهات">
            <i class="fas fa-bell"></i>
        </button>
        <button class="floating-btn tertiary" id="floatingExportBtn" title="تصدير البيانات">
            <i class="fas fa-download"></i>
        </button>
    </div>

    <!-- مؤشر التقدم -->
    <div class="progress-bar" id="progressBar">
        <div class="progress-fill" id="progressFill"></div>
    </div>

    <!-- نافذة تأكيد -->
    <div class="confirmation-modal" id="confirmationModal" style="display: none;">
        <div class="confirmation-content">
            <div class="confirmation-icon">
                <i class="fas fa-question-circle"></i>
            </div>
            <h3 id="confirmationTitle">تأكيد العملية</h3>
            <p id="confirmationMessage">هل أنت متأكد من هذه العملية؟</p>
            <div class="confirmation-buttons">
                <button class="btn-confirm" id="confirmBtn">تأكيد</button>
                <button class="btn-cancel" id="cancelBtn">إلغاء</button>
            </div>
        </div>
    </div>

    <!-- تحميل الملفات -->
    <script src="config.js"></script>
    <script src="script.js"></script>
    
    <script>
        // متغيرات عامة
        let autoRefreshInterval = null;
        let isAutoRefreshActive = false;
        
        // تهيئة التطبيق
        document.addEventListener('DOMContentLoaded', function() {
            try {
                initializeApp();
            } catch (error) {
                console.error('خطأ في تهيئة التطبيق:', error);
                showNotification('حدث خطأ في تهيئة التطبيق', 'error');
            }
        });

        // دالة تهيئة التطبيق
        function initializeApp() {
            updateWatchlistCounter();
            initializeEventListeners();
            
            // تحديث المعلومات السريعة كل 5 ثوانٍ بدلاً من كل ثانية
            setInterval(updateQuickInfo, 5000);
            
            // إظهار رسالة ترحيب
            showNotification('مرحباً بك في كاشف البامب للعملات الرقمية', 'success');
        }

        // دالة تحديث عداد قائمة المراقبة
        function updateWatchlistCounter() {
            try {
                const watchlist = JSON.parse(localStorage.getItem('watchlist')) || [];
                const counters = document.querySelectorAll('.watchlist-counter');
                
                counters.forEach(counter => {
                    if (counter) {
                        counter.textContent = watchlist.length;
                        counter.style.display = watchlist.length > 0 ? 'inline' : 'none';
                    }
                });
            } catch (error) {
                console.error('خطأ في تحديث عداد قائمة المراقبة:', error);
            }
        }

        // إضافة مستمعي الأحداث
        function initializeEventListeners() {
            // البحث
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('input', handleSearch);
            }

            // الترتيب
            const sortSelect = document.getElementById('sortSelect');
            if (sortSelect) {
                sortSelect.addEventListener('change', handleSort);
            }

            // أزرار الهيدر
            const watchlistBtn = document.getElementById('watchlistBtn');
            if (watchlistBtn) {
                watchlistBtn.addEventListener('click', showWatchlist);
            }

            const alertsBtn = document.getElementById('alertsBtn');
            if (alertsBtn) {
                alertsBtn.addEventListener('click', showAlertsManager);
            }

            const statisticsBtn = document.getElementById('statisticsBtn');
            if (statisticsBtn) {
                statisticsBtn.addEventListener('click', showStatistics);
            }

            const exportBtn = document.getElementById('exportBtn');
            if (exportBtn) {
                exportBtn.addEventListener('click', exportAllData);
            }

            // أزرار التذييل
            const scrollTopBtn = document.getElementById('scrollTopBtn');
            if (scrollTopBtn) {
                scrollTopBtn.addEventListener('click', scrollToTop);
            }

            const autoRefreshBtn = document.getElementById('autoRefreshBtn');
            if (autoRefreshBtn) {
                autoRefreshBtn.addEventListener('click', toggleAutoRefresh);
            }

            // الأزرار العائمة
            const floatingWatchlistBtn = document.getElementById('floatingWatchlistBtn');
            if (floatingWatchlistBtn) {
                floatingWatchlistBtn.addEventListener('click', showWatchlist);
            }

            const floatingAlertsBtn = document.getElementById('floatingAlertsBtn');
            if (floatingAlertsBtn) {
                floatingAlertsBtn.addEventListener('click', showAlertsManager);
            }

            const floatingExportBtn = document.getElementById('floatingExportBtn');
            if (floatingExportBtn) {
                floatingExportBtn.addEventListener('click', exportAllData);
            }

            // أزرار التأكيد
            const confirmBtn = document.getElementById('confirmBtn');
            if (confirmBtn) {
                confirmBtn.addEventListener('click', handleConfirmation);
            }

            const cancelBtn = document.getElementById('cancelBtn');
            if (cancelBtn) {
                cancelBtn.addEventListener('click', hideConfirmation);
            }

            // إغلاق النافذة المنبثقة
            const closeModal = document.getElementById('closeModal');
            if (closeModal) {
                closeModal.addEventListener('click', closeModalWindow);
            }

            // إغلاق النافذة عند النقر خارجها
            const modalOverlay = document.getElementById('modalOverlay');
            if (modalOverlay) {
                modalOverlay.addEventListener('click', function(e) {
                    if (e.target === modalOverlay) {
                        closeModalWindow();
                    }
                });
            }

            // أزرار الفلترة
            const filterBtns = document.querySelectorAll('.filter-btn');
            filterBtns.forEach(btn => {
                btn.addEventListener('click', handleFilter);
            });

            // زر التحديث
            const refreshBtn = document.getElementById('refreshBtn');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', refreshData);
            }
        }

        // دالة البحث
        function handleSearch(event) {
            try {
                const searchTerm = event.target.value.toLowerCase().trim();
                const coinCards = document.querySelectorAll('.coin-card');
                let visibleCount = 0;

                coinCards.forEach(card => {
                    const symbol = card.querySelector('.coin-symbol')?.textContent?.toLowerCase() || '';
                    const name = card.querySelector('.coin-name')?.textContent?.toLowerCase() || '';
                    const isVisible = symbol.includes(searchTerm) || name.includes(searchTerm);
                    
                    card.style.display = isVisible ? 'block' :
                    card.style.display = isVisible ? 'block' : 'none';
                    if (isVisible) visibleCount++;
                });

                // إظهار رسالة عدم وجود نتائج
                const noResults = document.getElementById('noResults');
                if (noResults) {
                    noResults.style.display = visibleCount === 0 && searchTerm !== '' ? 'block' : 'none';
                }
            } catch (error) {
                console.error('خطأ في البحث:', error);
            }
        }

        // دالة الترتيب
        function handleSort(event) {
            try {
                const sortBy = event.target.value;
                const coinsGrid = document.getElementById('coinsGrid');
                if (!coinsGrid) return;

                const coinCards = Array.from(coinsGrid.children);
                
                coinCards.sort((a, b) => {
                    let valueA, valueB;
                    
                    switch(sortBy) {
                        case 'score':
                            valueA = parseFloat(a.dataset.score) || 0;
                            valueB = parseFloat(b.dataset.score) || 0;
                            return valueB - valueA;
                        case 'change':
                            valueA = parseFloat(a.dataset.change) || 0;
                            valueB = parseFloat(b.dataset.change) || 0;
                            return valueB - valueA;
                        case 'volume':
                            valueA = parseFloat(a.dataset.volume) || 0;
                            valueB = parseFloat(b.dataset.volume) || 0;
                            return valueB - valueA;
                        case 'price':
                            valueA = parseFloat(a.dataset.price) || 0;
                            valueB = parseFloat(b.dataset.price) || 0;
                            return valueB - valueA;
                        default:
                            return 0;
                    }
                });

                // إعادة ترتيب العناصر
                coinCards.forEach(card => coinsGrid.appendChild(card));
            } catch (error) {
                console.error('خطأ في الترتيب:', error);
            }
        }

        // دالة الفلترة
        function handleFilter(event) {
            try {
                const filterBtns = document.querySelectorAll('.filter-btn');
                filterBtns.forEach(btn => btn.classList.remove('active'));
                event.target.classList.add('active');

                const scoreFilter = event.target.dataset.score;
                const coinCards = document.querySelectorAll('.coin-card');
                let visibleCount = 0;

                coinCards.forEach(card => {
                    const score = parseFloat(card.dataset.score) || 0;
                    let isVisible = true;

                    if (scoreFilter !== 'all') {
                        const minScore = parseInt(scoreFilter);
                        isVisible = score >= minScore;
                    }

                    card.style.display = isVisible ? 'block' : 'none';
                    if (isVisible) visibleCount++;
                });

                // إظهار رسالة عدم وجود نتائج
                const noResults = document.getElementById('noResults');
                if (noResults) {
                    noResults.style.display = visibleCount === 0 ? 'block' : 'none';
                }
            } catch (error) {
                console.error('خطأ في الفلترة:', error);
            }
        }

        // تحديث المعلومات السريعة
        function updateQuickInfo() {
            try {
                if (!window.detector || !window.detector.coins) return;
                
                const coins = window.detector.coins;
                const totalCoins = coins.length;
                const bullishCoins = coins.filter(coin => 
                    parseFloat(coin.analysis?.priceChange24h || 0) > 0
                ).length;
                const bearishCoins = coins.filter(coin => 
                    parseFloat(coin.analysis?.priceChange24h || 0) < 0
                ).length;
                const averageScore = totalCoins > 0 ? 
                    coins.reduce((sum, coin) => sum + (coin.adaptedScore || 0), 0) / totalCoins : 0;

                const elements = {
                    'totalCoins': totalCoins,
                    'bullishCoins': bullishCoins,
                    'bearishCoins': bearishCoins,
                    'averageScore': averageScore.toFixed(1)
                };

                Object.entries(elements).forEach(([id, value]) => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.textContent = value;
                    }
                });
            } catch (error) {
                console.error('خطأ في تحديث المعلومات السريعة:', error);
            }
        }

        // دوال الواجهة
        function showWatchlist() {
            try {
                console.log('عرض قائمة المراقبة');
                showNotification('تم فتح قائمة المراقبة', 'info');
                // سيتم تنفيذها في ملف JavaScript الرئيسي
            } catch (error) {
                console.error('خطأ في عرض قائمة المراقبة:', error);
            }
        }

        function showAlertsManager() {
            try {
                console.log('عرض مدير التنبيهات');
                showNotification('تم فتح مدير التنبيهات', 'info');
                // سيتم تنفيذها في ملف JavaScript الرئيسي
            } catch (error) {
                console.error('خطأ في عرض مدير التنبيهات:', error);
            }
        }

        function showStatistics() {
            try {
                console.log('عرض الإحصائيات');
                showNotification('تم فتح الإحصائيات', 'info');
                // سيتم تنفيذها في ملف JavaScript الرئيسي
            } catch (error) {
                console.error('خطأ في عرض الإحصائيات:', error);
            }
        }

        function exportAllData() {
            try {
                console.log('تصدير البيانات');
                showNotification('جاري تصدير البيانات...', 'info');
                // سيتم تنفيذها في ملف JavaScript الرئيسي
            } catch (error) {
                console.error('خطأ في تصدير البيانات:', error);
            }
        }

        function refreshData() {
            try {
                const refreshBtn = document.getElementById('refreshBtn');
                if (refreshBtn) {
                    refreshBtn.disabled = true;
                    refreshBtn.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i> جاري التحديث...';
                }

                showNotification('جاري تحديث البيانات...', 'info');
                
                // إعادة تفعيل الزر بعد 3 ثوانٍ
                setTimeout(() => {
                    if (refreshBtn) {
                        refreshBtn.disabled = false;
                        refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> تحديث البيانات';
                    }
                    
                    const now = new Date().toLocaleString('ar-SA');
                    const lastUpdateElements = document.querySelectorAll('#lastUpdate, #footerLastUpdate');
                    lastUpdateElements.forEach(element => {
                        if (element) element.textContent = now;
                    });
                    
                    showNotification('تم تحديث البيانات بنجاح', 'success');
                }, 3000);

                // سيتم تنفيذها في ملف JavaScript الرئيسي
            } catch (error) {
                console.error('خطأ في تحديث البيانات:', error);
                showNotification('فشل في تحديث البيانات', 'error');
            }
        }

        // دوال مساعدة
        function scrollToTop() {
            try {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } catch (error) {
                console.error('خطأ في التمرير للأعلى:', error);
            }
        }

        function toggleAutoRefresh() {
            try {
                const autoRefreshText = document.getElementById('autoRefreshText');
                
                if (isAutoRefreshActive) {
                    clearInterval(autoRefreshInterval);
                    isAutoRefreshActive = false;
                    if (autoRefreshText) {
                        autoRefreshText.textContent = 'تفعيل التحديث التلقائي';
                    }
                    showNotification('تم إيقاف التحديث التلقائي', 'info');
                } else {
                    autoRefreshInterval = setInterval(refreshData, 60000); // كل دقيقة
                    isAutoRefreshActive = true;
                    if (autoRefreshText) {
                        autoRefreshText.textContent = 'إيقاف التحديث التلقائي';
                    }
                    showNotification('تم تفعيل التحديث التلقائي', 'success');
                }
            } catch (error) {
                console.error('خطأ في تبديل التحديث التلقائي:', error);
            }
        }

        function handleConfirmation() {
            try {
                console.log('تم تأكيد العملية');
                hideConfirmation();
                showNotification('تم تنفيذ العملية بنجاح', 'success');
            } catch (error) {
                console.error('خطأ في معالجة التأكيد:', error);
            }
        }

        function hideConfirmation() {
            try {
                const confirmationModal = document.getElementById('confirmationModal');
                if (confirmationModal) {
                    confirmationModal.style.display = 'none';
                }
            } catch (error) {
                console.error('خطأ في إخفاء نافذة التأكيد:', error);
            }
        }

        function closeModalWindow() {
            try {
                const modalOverlay = document.getElementById('modalOverlay');
                if (modalOverlay) {
                    modalOverlay.style.display = 'none';
                }
            } catch (error) {
                console.error('خطأ في إغلاق النافذة المنبثقة:', error);
            }
        }

        // دالة عرض الإشعارات
        function showNotification(message, type = 'info') {
            try {
                const container = document.getElementById('notificationsContainer');
                if (!container) return;

                const notification = document.createElement('div');
                notification.className = `notification notification-${type}`;
                notification.innerHTML = `
                    <i class="fas fa-${getNotificationIcon(type)}"></i>
                    <span>${message}</span>
                    <button class="notification-close" onclick="this.parentElement.remove()">
                        <i class="fas fa-times"></i>
                    </button>
                `;

                container.appendChild(notification);

                // إزالة الإشعار تلقائياً بعد 5 ثوانٍ
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, 5000);
            } catch (error) {
                console.error('خطأ في عرض الإشعار:', error);
            }
        }

        function getNotificationIcon(type) {
            const icons = {
                'success': 'check-circle',
                'error': 'exclamation-circle',
                'warning': 'exclamation-triangle',
                'info': 'info-circle'
            };
            return icons[type] || 'info-circle';
        }

        // معالجة الأخطاء العامة
        window.addEventListener('error', function(event) {
            console.error('خطأ عام في التطبيق:', event.error);
            showNotification('حدث خطأ غير متوقع', 'error');
        });

        // معالجة الأخطاء غير المعالجة
        window.addEventListener('unhandledrejection', function(event) {
            console.error('خطأ غير معالج:', event.reason);
            showNotification('حدث خطأ في العملية', 'error');
        });
    </script>
</body>
</html>
