                    card.style.display = isVisible ? 'block' : 'none';
                    if (isVisible) visibleCount++;
                });

                // إظهار رسالة عدم وجود نتائج
                const noResults = document.getElementById('noResults');
                if (noResults) {
                    noResults.style.display = visibleCount === 0 && searchTerm !== '' ? 'block' : 'none';
                }
            } catch (error) {
                console.error('خطأ في البحث:', error);
            }
        }

        // دالة الترتيب
        function handleSort(event) {
            try {
                const sortBy = event.target.value;
                const coinsGrid = document.getElementById('coinsGrid');
                if (!coinsGrid) return;

                const coinCards = Array.from(coinsGrid.children);
                
                coinCards.sort((a, b) => {
                    let valueA, valueB;
                    
                    switch(sortBy) {
                        case 'score':
                            valueA = parseFloat(a.dataset.score) || 0;
                            valueB = parseFloat(b.dataset.score) || 0;
                            return valueB - valueA;
                        case 'change':
                            valueA = parseFloat(a.dataset.change) || 0;
                            valueB = parseFloat(b.dataset.change) || 0;
                            return valueB - valueA;
                        case 'volume':
                            valueA = parseFloat(a.dataset.volume) || 0;
                            valueB = parseFloat(b.dataset.volume) || 0;
                            return valueB - valueA;
                        case 'price':
                            valueA = parseFloat(a.dataset.price) || 0;
                            valueB = parseFloat(b.dataset.price) || 0;
                            return valueB - valueA;
                        default:
                            return 0;
                    }
                });

                // إعادة ترتيب العناصر
                coinCards.forEach(card => coinsGrid.appendChild(card));
            } catch (error) {
                console.error('خطأ في الترتيب:', error);
            }
        }

        // دالة الفلترة
        function handleFilter(event) {
            try {
                const filterBtns = document.querySelectorAll('.filter-btn');
                filterBtns.forEach(btn => btn.classList.remove('active'));
                event.target.classList.add('active');

                const scoreFilter = event.target.dataset.score;
                const coinCards = document.querySelectorAll('.coin-card');
                let visibleCount = 0;

                coinCards.forEach(card => {
                    const score = parseFloat(card.dataset.score) || 0;
                    let isVisible = true;

                    if (scoreFilter !== 'all') {
                        const minScore = parseInt(scoreFilter);
                        isVisible = score >= minScore;
                    }

                    card.style.display = isVisible ? 'block' : 'none';
                    if (isVisible) visibleCount++;
                });

                // إظهار رسالة عدم وجود نتائج
                const noResults = document.getElementById('noResults');
                if (noResults) {
                    noResults.style.display = visibleCount === 0 ? 'block' : 'none';
                }
            } catch (error) {
                console.error('خطأ في الفلترة:', error);
            }
        }

        // تحديث المعلومات السريعة
        function updateQuickInfo() {
            try {
                if (!window.detector || !window.detector.coins) return;
                
                const coins = window.detector.coins;
                const totalCoins = coins.length;
                const bullishCoins = coins.filter(coin => 
                    parseFloat(coin.analysis?.priceChange24h || 0) > 0
                ).length;
                const bearishCoins = coins.filter(coin => 
                    parseFloat(coin.analysis?.priceChange24h || 0) < 0
                ).length;
                const averageScore = totalCoins > 0 ? 
                    coins.reduce((sum, coin) => sum + (coin.adaptedScore || 0), 0) / totalCoins : 0;

                const elements = {
                    'totalCoins': totalCoins,
                    'bullishCoins': bullishCoins,
                    'bearishCoins': bearishCoins,
                    'averageScore': averageScore.toFixed(1)
                };

                Object.entries(elements).forEach(([id, value]) => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.textContent = value;
                    }
                });
            } catch (error) {
                console.error('خطأ في تحديث المعلومات السريعة:', error);
            }
        }

        // دوال الواجهة
        function showWatchlist() {
            try {
                console.log('عرض قائمة المراقبة');
                showNotification('تم فتح قائمة المراقبة', 'info');
                // سيتم تنفيذها في ملف JavaScript الرئيسي
            } catch (error) {
                console.error('خطأ في عرض قائمة المراقبة:', error);
            }
        }

        function showAlertsManager() {
            try {
                console.log('عرض مدير التنبيهات');
                showNotification('تم فتح مدير التنبيهات', 'info');
                // سيتم تنفيذها في ملف JavaScript الرئيسي
            } catch (error) {
                console.error('خطأ في عرض مدير التنبيهات:', error);
            }
        }

        function showStatistics() {
            try {
                console.log('عرض الإحصائيات');
                showNotification('تم فتح الإحصائيات', 'info');
                // سيتم تنفيذها في ملف JavaScript الرئيسي
            } catch (error) {
                console.error('خطأ في عرض الإحصائيات:', error);
            }
        }

        function exportAllData() {
            try {
                console.log('تصدير البيانات');
                showNotification('جاري تصدير البيانات...', 'info');
                // سيتم تنفيذها في ملف JavaScript الرئيسي
            } catch (error) {
                console.error('خطأ في تصدير البيانات:', error);
            }
        }

        function refreshData() {
            try {
                const refreshBtn = document.getElementById('refreshBtn');
                if (refreshBtn) {
                    refreshBtn.disabled = true;
                    refreshBtn.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i> جاري التحديث...';
                }

                showNotification('جاري تحديث البيانات...', 'info');
                
                // إعادة تفعيل الزر بعد 3 ثوانٍ
                setTimeout(() => {
                    if (refreshBtn) {
                        refreshBtn.disabled = false;
                        refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> تحديث البيانات';
                    }
                    
                    const now = new Date().toLocaleString('ar-SA');
                    const lastUpdateElements = document.querySelectorAll('#lastUpdate, #footerLastUpdate');
                    lastUpdateElements.forEach(element => {
                        if (element) element.textContent = now;
                    });
                    
                    showNotification('تم تحديث البيانات بنجاح', 'success');
                }, 3000);

                // سيتم تنفيذها في ملف JavaScript الرئيسي
            } catch (error) {
                console.error('خطأ في تحديث البيانات:', error);
                showNotification('فشل في تحديث البيانات', 'error');
            }
        }

        // دوال مساعدة
        function scrollToTop() {
            try {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } catch (error) {
                console.error('خطأ في التمرير للأعلى:', error);
            }
        }

        function toggleAutoRefresh() {
            try {
                const autoRefreshText = document.getElementById('autoRefreshText');
                
                if (isAutoRefreshActive) {
                    clearInterval(autoRefreshInterval);
                    isAutoRefreshActive = false;
                    if (autoRefreshText) {
                        autoRefreshText.textContent = 'تفعيل التحديث التلقائي';
                    }
                    showNotification('تم إيقاف التحديث التلقائي', 'info');
                } else {
                    autoRefreshInterval = setInterval(refreshData, 60000); // كل دقيقة
                    isAutoRefreshActive = true;
                    if (autoRefreshText) {
                        autoRefreshText.textContent = 'إيقاف التحديث التلقائي';
                    }
                    showNotification('تم تفعيل التحديث التلقائي', 'success');
                }
            } catch (error) {
                console.error('خطأ في تبديل التحديث التلقائي:', error);
            }
        }

        function handleConfirmation() {
            try {
                console.log('تم تأكيد العملية');
                hideConfirmation();
                showNotification('تم تنفيذ العملية بنجاح', 'success');
            } catch (error) {
                console.error('خطأ في معالجة التأكيد:', error);
            }
        }

        function hideConfirmation() {
            try {
                const confirmationModal = document.getElementById('confirmationModal');
                if (confirmationModal) {
                    confirmationModal.style.display = 'none';
                }
            } catch (error) {
                console.error('خطأ في إخفاء نافذة التأكيد:', error);
            }
        }

        function closeModalWindow() {
            try {
                const modalOverlay = document.getElementById('modalOverlay');
                if (modalOverlay) {
                    modalOverlay.style.display = 'none';
                }
            } catch (error) {
                console.error('خطأ في إغلاق النافذة المنبثقة:', error);
            }
        }

        // دالة عرض الإشعارات
        function showNotification(message, type = 'info') {
            try {
                const container = document.getElementById('notificationsContainer');
                if (!container) return;

                const notification = document.createElement('div');
                notification.className = `notification notification-${type}`;
                notification.innerHTML = `
                    <i class="fas fa-${getNotificationIcon(type)}"></i>
                    <span>${message}</span>
                    <button class="notification-close" onclick="this.parentElement.remove()">
                        <i class="fas fa-times"></i>
                    </button>
                `;

                container.appendChild(notification);

                // إزالة الإشعار تلقائياً بعد 5 ثوانٍ
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, 5000);
            } catch (error) {
                console.error('خطأ في عرض الإشعار:', error);
            }
        }

        function getNotificationIcon(type) {
            const icons = {
                'success': 'check-circle',
                'error': 'exclamation-circle',
                'warning': 'exclamation-triangle',
                'info': 'info-circle'
            };
            return icons[type] || 'info-circle';
        }

        // معالجة الأخطاء العامة
        window.addEventListener('error', function(event) {
            console.error('خطأ عام في التطبيق:', event.error);
            showNotification('حدث خطأ غير متوقع', 'error');
        });

        // معالجة الأخطاء غير المعالجة
        window.addEventListener('unhandledrejection', function(event) {
            console.error('خطأ غير معالج:', event.reason);
            showNotification('حدث خطأ في العملية', 'error');
        });
    </script>
</body>
</html>
